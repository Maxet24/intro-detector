# Intro Finder

Intro Finder - система определения заставок в потоке видео без разметки сезонов или использования какой-либо информации, кроме видео и аудио материала. Система легко масштабируется на миллионы видеофрагментов с помощью быстрой системы поиска Faiss и embedding'ов. Вся система выполнена по стандартам ООП.

# Архитектура

<div align="center">
  <img src="https://i.ibb.co/cS6H2SF5/2025-06-17-201530.png">
</div>

## Добавление видео и деление на сцены
1. Происходит загрузка видео, а точнее первой половины видео, так как заставка почти всегда находится в первой половине серий.
2. Далее видео делится на сцены, используя среднее арифметическое взвешенное изменений пикселей в цветовом пространстве HSV с помощью [PySceneDetect](https://www.scenedetect.com/).
3. Из каждой сцены берется кадр для последующего сравнения и проверяется, не является ли он просто черным экраном.
Все операции происходят в классе `VideoItem`
## Embedding кадров CLIP ViT-B/32
Далее мы берем трансформер [CLIP ViT-B/32](https://github.com/openai/CLIP), который переносит картинку в 512-мерный вектор, который мы будем использовать для сравнения фреймов. Библиотека поддерживает CUDA GPU, так что вычисления будут выполнятся значительно быстрее.
## Поиск схожих Faiss
Для быстрого поиска визуально схожих кадров между видео используется [Faiss (Facebook AI Similarity Search)](https://github.com/facebookresearch/faiss) — библиотека для поиска по векторам высокой размерности, оптимизированная для GPU. Векторы сравниваются по косинусному расстоянию (через inner product), и для каждого кадра из нового видео находятся наиболее близкие кадры из базы.
## Расширение совпадений
После нахождения похожих кадров происходит **расширение** каждого совпадения влево и вправо по таймлайну, чтобы найти целые фрагменты, а не отдельные кадры. Это позволяет точно определить границы заставки и уменьшить количество ложных срабатываний. Расширение выполняется путем сравнения каждого следующего кадра в видео A и в видео B по косинусовому расстоянию с помощью тех же эмбеддингов CLIP.
## Объединение видео в сериалы
Класс `SeriesManager` позволяет добавлять видео по одному, автоматически:

- сравнивая их с ранее добавленными видео;
- группируя в сериалы по фактическим совпадениям сцен;
- кэшируя эмбеддинги и метаданные для последующего масштабируемого поиска;
- сохраняет результаты сравнения и сериалов в json файл.

Такой подход не требует разметки, названий сериалов или сезонных меток — только само видео.

# Использование
```python
from clipEmbedder import ClipEmbedder
from videoItem import VideoItem
from seriesManager import SeriesManager
from pathlib import Path

embedder = ClipEmbedder()

series_manager = SeriesManager('unpaired', 'series', 'timestamps.json', embedder)
folder = Path(r'data_train_short\data_train_short')
video_paths = list(folder.rglob("*.mp4"))

for video_path in video_paths:
    print(f"Добавляется видео: {video_path}")
    video = VideoItem(str(video_path))
    series_manager.add_video(video)
```
Этот код автоматически начнет добавление всех видео поочередно, объединяя их в сериалы.
